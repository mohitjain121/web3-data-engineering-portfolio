/*
Description: Calculate average and median USD holdings for a set of wallets.
*/

WITH 
  price AS (
    SELECT
      contract_address,
      decimals,
      symbol,
      AVG(median_price) AS price
    FROM
      prices."approx_prices_from_dex_data"
    WHERE
      hour > NOW() - '7 DAYS':: INTERVAL
    GROUP BY
      contract_address,
      decimals,
      symbol
  ),
  holdings AS (
    SELECT
      wallet,
      contract_address,
      SUM(amount) AS amount
    FROM
      (
        SELECT
          "from" AS wallet,
          contract_address,
          (-1) * value AS amount
        FROM
          erc20."ERC20_evt_Transfer"
        WHERE
          "from" IN (
            '\xcf0Fb4D249b8C2F17dd805aC2b6F28fFC3D0049C',
            '\x71c199C366625329064df3d08191CDC0e85AC2eA',
            '\xEd55793bda1aeC0A3a98cc5f092e071E5785106C',
            '\xaD928e545cf5598802B3c601E04B0CFE6bf6351C',
            '\x304160997E2D06fbfc0f54a8a714DC4cDf7B9E5F',
            '\xF68D2BfCecd7895BBa05a7451Dd09A1749026454',
            '\xA297A06221aB3c846354e7Fb1B37EB5DA06bDA21',
            '\xaB888291F4127352B655fd476F64AC2ebfb8fe76',
            '\x5B36002E5Ee1103A44246f67b067FD5509b97A9E',
            '\x52B0c756d6f36af804C51211BD5A1fA4AB5dc911',
            '\x9e490445a8323D04641E5a8DFc8f23560F86c797',
            '\x9bEa8d579a72785Fd79d5356864ec002f02281A9',
            '\xCC74A5aF5aF819C6b8e997340e47FCb4cA75bf7e',
            '\x324Fbd9536bf3d77d36137310fd4abe5130DfEA9',
            '\x38430336153468dcf36Af5cea7D6bc472425633A',
            '\xB6bd1b9b3e6e3512BB354789289f6d8FBc0F65BC',
            '\x8482E81BBb802275247bf4CDab9bC67020231860',
            '\x5368B653B97d9C454984c92eef25584eCC347Ae9',
            '\x841AD0AbAb2D33520ca236A2F5D8b038adDc12BA',
            '\xBFe2867dF4e99E4028afA19075F295f325563cb3',
            '\x8B600c7Ef1D97225860a7996b63c5b8b116182d5',
            '\xff5144b6D2aAa53eAdE50C308c23D5C2151582D2',
            '\x9A1e0c819F4e6608082cc28D515648edAb043B85',
            '\xd59c20eFa3fCC5871d6789f725244465BcD6AA0e',
            '\x2ED0F4e9769591d8eff038ABD884187c8101C7f3',
            '\x6d38db12733795e04256Da2d42362b621F42e537',
            '\x037DBeb376900653E8b1744ccfD30f074f9F282A',
            '\x82e9A55aFb16A26FF840E83DeC37E7088774C8ee',
            '\x500Fca064b8Eed97d0b2581904f3264408438423',
            '\x3b9288Ba5DCc2051B1cd243BbaedDec8149EC50c',
            '\x6fcEc5d08f585fBA9e08d188031B5B97730908c3',
            '\x1Cf693eceEbEee99aD60e82973E2d4829C801335',
            '\xEB50840CdecB7DF40FA9fDB435922071865b65BE',
            '\x75Be7f29F8241f1Bac65a6c5Aa5Ac4Ba9365ba11',
            '\xCD133D337eAD9C2AC799eC7524A1e0f8Aa30c3b1',
            '\x82AF599aE8a62842dA38be6E5d4b14cD5882bddb',
            '\xCB53a818042Db647cb01672751B0E4efCa29cF55',
            '\xd31A84c20bc430aD75E6a1903E7dDbee52211072',
            '\x8be60fe9F7C8d940D8DA9d5dDD0D8E0c15A4288B',
            '\xF6459c66D232ec11F082fF3864BE3A67461aBA32',
            '\xcd0b67a61E5e8F4616c19e421e929813B6D947df',
            '\x1eda14dA76e7e56dc001D9D1A47CAe888FD14E5B',
            '\xb037aa9f0bB7B2F77A05Adc35C2BeEa97f11aCD6',
            '\x4081073A079e177677c3c443e2C615c87362239A',
            '\xE9Bd34bf7FA65988cEae405F239D01135c1F6b01',
            '\x2F4BAaF0cC5d543d7f8DC4059369f8F9A0a21409',
            '\x5803879dc2871FF5B079Bb4C41601c8789CA4f8C',
            '\x4Fc06231D9bB175dAcF6b482ea236d5DE1101317',
            '\x2aBC381364a470593CaccE7DDCeF3fCf648125e4',
            '\x0DE3f84782427380c6588A9dCA8675A5c40893Cb',
            '\xb804D0a16870E2fF870935e336733bC7fbE65BEB',
            '\x53aA991b2A2a1b6Ce7b54747b9bEA230C61603Bf',
            '\x2Babe76345D7Eb15f6a1C0CDDba04d8ee44491d5',
            '\xFCFA4369EAa965AC4e36f1Dd9fd2852C6542b0F7',
            '\x310C58A54A13a4975BA5D27530Ea8a8fF6F2FCa5',
            '\x86Bc0B034659801B92F10D85f8EefA40F5a97ee7',
            '\x4b2E3F09cc773957895f83A5c828C143CbEcbb72',
            '\x481787bBa8C56f801Db8bdb336844b771c011246',
            '\xcF10A8E7c907144cc87721aC1fD7Ac75a8aebeC7',
            '\x02fFb9B4bBC29f9A59b20C541d369C5add62a5a3',
            '\x54AE19194c33d03dc3e1D19b223D475139e94182',
            '\x4A84756A856327c8aF94C40D4dF8393eCF680605',
            '\x8a9046B122BffA179E16d6e4fb00EFB8bD734A8d',
            '\x6433c4d4D5bBFAda8CB9d4f3Df1444B4D32e3E81',
            '\x3C325DfeafaC6F08DB973E7dfD6E25490aE00Af1',
            '\x5AADB54B463204059ACB58262EC8ed49EFbddbaa',
            '\x76E4f864bbEb60Bee66Ff5BbcD32dEcAF7FBDE71',
            '\xbA1DD0D124231E6e059ff2f08A50af100C51679b',
            '\x15Fab1cC5262D69853b1196f74d38C7FC96Fc6D7',
            '\x4fd787803dB60816F16B121cC7c5637263f1736f',
            '\xF3e0788B2Bbd45a9693d803e5a0198549471534d',
            '\x75E29F79b03eb9836D8CDC0B1EdDCd686655Eb43',
            '\x018439894b681cC2aAdDB613A425a1cfA6e59c29',
            '\x119a98C8f6B1D49D07CEf5c2bE6c52CbcBaB1498',
            '\xa8B64347b0f9DcDDDA307F3d1cfEfe4D38AD813a',
            '\xDA24EE2C4B4b1Ea69dE3AA9c820438C7069D7D83',
            '\x021699aaf005DABD166bF803C65Fc90529fcfF4a',
            '\x208bE48B21338a25C0A7b10088637F4faf27b54c',
            '\x7977B909D55a53F9c73140f7F611EaF0638238Ed',
            '\xE5b1918D99f9B5b63817F6C9A7afdA744eF1F647',
            '\xA3F066285ad422407acbF6765FC1a71505bc610d',
            '\xd671422bdDC48942f8C1F8f5C8662Efb6aB0afF4',
            '\x5088e77AD09d52501f34711AEa2C0F1226c6e255',
            '\x164af5cFD35eedff0B6c21AC4CB6c84836cb8b2d',
            '\x46D2f3DBe93156ED2fbfcBeA4F470d032Ba5637c',
            '\x2805DdF1DFEDeCa06752907F493F5A5c9bb2C902',
            '\xBd94b2e23162ae29e74521dd38503aAfa76BeA65',
            '\xa741296A1E9DDc3D6Cf431B73C6225cFb5F6693a',
            '\x81Ba93B26bCe8cA5d649B6607DF15E6D45462D8F',
            '\x076B9d3dDd46dB415ED7fEb632EF6A485E6bbC79',
            '\xbdbc9751D73f29CFDDB285EBa08FfDB7B3395dfE',
            '\x48b0320c7E9Fc671841a713156dA73df75765c66',
            '\x38A8194DFC7E001805C89fE345F55Be635F023AC',
            '\xc69eC94F3dcE57B622D790E773899bc1d11A8074',
            '\x27C7E978e4dA4581588BB40a521d5a7A6d31b33D',
            '\x7Ea9b8ba0d889Ba42458f657Ed27244AD593dfe7',
            '\x2B5b64dF5E31A31d2E48dE94b15c2093bC4CC09C',
            '\xD131F1BcDd547e067Af447dD3C36C99d6be9FdEB',
            '\xbED050C15224a53a12815Fa79F2B1EF431887Eb2',
            '\xf018B923bEbdef7a8124371B322D7E29a08c3198'
          )
        UNION
        SELECT
          "to" AS wallet,
          contract_address,
          value AS amount
        FROM
          erc20."ERC20_evt_Transfer"
        WHERE
          "to" IN (
            '\xcf0Fb4D249b8C2F17dd805aC2b6F28fFC3D0049C',
            '\x71c199C366625329064df3d08191CDC0e85AC2eA',
            '\xEd55793bda1aeC0A3a98cc5f092e071E5785106C',
            '\xaD928e545cf5598802B3c601E04B0CFE6bf6351C',
            '\x304160997E2D06fbfc0f54a8a714DC4cDf7B9E5F',
            '\xF68D2BfCecd7895BBa05a7451Dd09A1749026454',
            '\xA297A06221aB3c846354e7Fb1B37EB5DA06bDA21',
            '\xaB888291F4127352B655fd476F64AC2ebfb8fe76',
            '\x5B36002E5Ee1103A44246f67b067FD5509b97A9E',
            '\x52B0c756d6f36af804C51211BD5A1fA4AB5dc911',
            '\x9e490445a8323D04641E5a8DFc8f23560F86c797',
            '\x9bEa8d579a72785Fd79d5356864ec002f02281A9',
            '\xCC74A5aF5aF819C6b8e997340e47FCb4cA75bf7e',
            '\x324Fbd9536bf3d77d36137310fd4abe5130DfEA9',
            '\x38430336153468dcf36Af5cea7D6bc472425633A',
            '\xB6bd1b9b3e6e3512BB354789289f6d8FBc0F65BC',
            '\x8482E81BBb802275247bf4CDab9bC67020231860',
            '\x5368B653B97d9C454984c92eef25584eCC347Ae9',
            '\x841AD0AbAb2D33520ca236A2F5D8b038adDc12BA',
            '\xBFe2867dF4e99E4028afA19075F295f325563cb3',
            '\x8B600c7Ef1D97225860a7996b63c5b8b116182d5',
            '\xff5144b6D2aAa53eAdE50C308c23D5C2151582D2',
            '\x9A1e0c819F4e6608082cc28D515648edAb043B85',
            '\xd59c20eFa3fCC5871d6789f725244465BcD6AA0e',
            '\x2ED0F4e9769591d8eff038ABD884187c8101C7f3',
            '\x6d38db12733795e04256Da2d42362b621F42e537',
            '\x037DBeb376900653E8b1744ccfD30f074f9F282A',
            '\x82e9A55aFb16A26FF840E83DeC37E7088774C8ee',
            '\x500Fca064b8Eed97d0b2581904f3264408438423',
            '\x3b9288Ba5DCc2051B1cd243BbaedDec8149EC50c',
            '\x6fcEc5d08f585fBA9e08d188031B5B97730908c3',
            '\x1Cf693eceEbEee99aD60e82973E2d4829C801335',
            '\xEB50840CdecB7DF40FA9fDB435922071865b65BE',
            '\x75Be7f29F8241f1Bac65a6c5Aa5Ac4Ba9365ba11',
            '\xCD133D337eAD9C2AC799eC7524A1e0f8Aa30c3b1',
            '\x82AF599aE8a62842dA38be6E5d4b14cD5882bddb',
            '\xCB53a818042Db647cb01672751B0E4efCa29cF55',
            '\xd31A84c20bc430aD75E6a1903E7dDbee52211072',
            '\x8be60fe9F7C8d940D8DA9d5dDD0D8E0c15A4288B',
            '\xF6459c66D232ec11F082fF3864BE3A67461aBA32',
            '\xcd0b67a61E5e8F4616c19e421e929813B6D947df',
            '\x1eda14dA76e7e56dc001D9D1A47CAe888FD14E5B',
            '\xb037aa9f0bB7B2F77A05Adc35C2BeEa97f11aCD6',
            '\x4081073A079e177677c3c443e2C615c87362239A',
            '\xE9Bd34bf7FA65988cEae405F239D01135c1F6b01',
            '\x2F4BAaF0cC5d543d7f8DC4059369f8F9A0a21409',
            '\x5803879dc2871FF5B079Bb4C41601c8789CA4f8C',
            '\x4Fc06231D9bB175dAcF6b482ea236d5DE1101317',
            '\x2aBC381364a470593CaccE7DDCeF3fCf648125e4',
            '\x0DE3f84782427380c6588A9dCA8675A5c40893Cb',
            '\xb804D0a16870E2fF870935e336733bC7fbE65BEB',
            '\x53aA991b2A2a1b6Ce7b54747b9bEA230C61603Bf',
            '\x2Babe76345D7Eb15f6a1C0CDDba04d8ee44491d5',
            '\xFCFA4369EAa965AC4e36f1Dd9fd2852C6542b0F7',
            '\x310C58A54A13a4975BA5D27530Ea8a8fF6F2FCa5',
            '\x86Bc0B034659801B92F10D85f8EefA40F5a97ee7',
            '\x4b2E3F09cc773957895f83A5c828C143CbEcbb72',
            '\x481787bBa8C56f801Db8bdb336844b771c011246',
            '\xcF10A8E7c907144cc87721aC1fD7Ac75a8aebeC7',
            '\x02fFb9B4bBC29f9A59b20C541d369C5add62a5a3',
            '\x54AE19194c33d03dc3e1D19b223D475139e94182',
            '\x4A84756A856327c8aF94C40D4dF8393eCF680605',
            '\x8a9046B122BffA179E16d6e4fb00EFB8bD734A8d',
            '\x6433c4d4D5bBFAda8CB9d4f3Df1444B4D32e3E81',
            '\x3C325DfeafaC6F08DB973E7dfD6E25490aE00Af1',
            '\x5AADB54B463204059ACB58262EC8ed49EFbddbaa',
            '\x76E4f864bbEb60Bee66Ff5BbcD32dEcAF7FBDE71',
            '\xbA1DD0D124231E6e059ff2f08A50af100C51679b',
            '\x15Fab1cC5262D69853b1196f74d38C7FC96Fc6D7',
            '\x4fd787803dB60816F16B121cC7c5637263f1736f',
            '\xF3e0788B2Bbd45a9693d803e5a0198549471534d',
            '\x75E29F79b03eb9836D8CDC0B1EdDCd686655Eb43',
            '\x018439894b681cC2aAdDB613A425a1cfA6e59c29',
            '\x119a98C8f6B1D49D07CEf5c2bE6c52CbcBaB1498',
            '\xa8B64347b0f9DcDDDA307F3d1cfEfe4D38AD813a',
            '\xDA24EE2C4B4b1Ea69dE3AA9c820438C7069D7D83',
            '\x021699aaf005DABD166bF803C65Fc90529fcfF4a',
            '\x208bE48B21338a25C0A7b10088637F4faf27b54c',
            '\x7977B909D55a53F9c73140f7F611EaF0638238Ed',
            '\xE5b1918D99f9B5b63817F6C9A7afdA744eF1F647',
            '\xA3F066285ad422407acbF6765FC1a71505bc610d',
            '\xd671422bdDC48942f8C1F8f5C8662Efb6aB0afF4',
            '\x5088e77AD09d52501f34711AEa2C0F1226c6e255',
            '\x164af5cFD35eedff0B6c21AC4CB6c84836cb8b2d',
            '\x46D2f3DBe93156ED2fbfcBeA4F470d032Ba5637c',
            '\x2805DdF1DFEDeCa06752907F493F5A5c9bb2C902',
            '\xBd94b2e23162ae29e74521dd38503aAfa76BeA65',
            '\xa741296A1E9DDc3D6Cf431B73C6225cFb5F6693a',
            '\x81Ba93B26bCe8cA5d649B6607DF15E6D45462D8F',
            '\x076B9d3dDd46dB415ED7fEb632EF6A485E6bbC79',
            '\xbdbc9751D73f29CFDDB285EBa08FfDB7B3395dfE',
            '\x48b0320c7E9Fc671841a713156dA73df75765c66',
            '\x38A8194DFC7E001805C89fE345F55Be635F023AC',
            '\xc69eC94F3dcE57B622D790E773899bc1d11A8074',
            '\x27C7E978e4dA4581588BB40a521d5a7A6d31b33D',
            '\x7Ea9b8ba0d889Ba42458f657Ed27244AD593dfe7',
            '\x2B5b64dF5E31A31d2E48dE94b15c2093bC4CC09C',
            '\xD131F1BcDd547e067Af447dD3C36C99d6be9FdEB',
            '\xbED050C15224a53a12815Fa79F2B1EF431887Eb2',
            '\xf018B923bEbdef7a8124371B322D7E29a08c3198'
          )
      ) x
    GROUP BY
      wallet,
      contract_address
  )
SELECT
  AVG(usd_holdings) AS avg_holding,
  PERCENTILE_CONT(0.5) WITHIN GROUP(
    ORDER BY
      usd_holdings
  ) AS med_holding
FROM
  (
    SELECT
      wallet,
      SUM(usd_holdings) AS usd_holdings
    FROM
      (
        SELECT
          wallet,
          symbol,
          h.contract_address,
          amount * price / 10 ^ decimals AS usd_holdings
        FROM
          holdings h
          LEFT JOIN price p ON h.contract_address = p.contract_address
        WHERE
          amount > 0
      ) h
    GROUP BY
      wallet
  ) x